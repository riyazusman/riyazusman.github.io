<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Regal Stlite Handshake Test</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.39.0/build/stlite.css" />
</head>
<body>
    <div id="root"></div>
    <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.39.0/build/stlite.js"></script>
    <script>
        stlite.mount({
            // REMOVED curl_cffi and pandas for initial test speed
            requirements: [], 
            files: {
                "app.py": `
import streamlit as st
import json
import pyodide.http
import asyncio

st.set_page_config(page_title="Lightweight Handshake")
st.title("ðŸ¦Š Stlite Handshake v2")

# 1. Target and Proxy
theater_code = "0227"
target_url = f"https://www.regmovies.com/api/getShowtimes?theatres={theater_code}"
# Using AllOrigins as the bridge
final_url = f"https://api.allorigins.win/raw?url={target_url}"

st.write("Click below to test the connection using **your** local IP.")

if st.button("ðŸš€ Test Handshake"):
    async def run_fetch():
        try:
            st.info("Attempting fetch via Browser IP...")
            # Use pyfetch for WASM-compatible requests
            response = await pyodide.http.pyfetch(final_url)
            
            if response.status == 200:
                data = await response.json()
                st.success("ðŸŽ‰ SUCCESS! Data retrieved.")
                st.json(data)
            else:
                st.error(f"Status: {response.status}")
                st.warning("Cloudflare likely blocked the proxy's IP.")
        except Exception as e:
            st.error(f"Fetch Error: {str(e)}")

    # Run the async fetch
    asyncio.ensure_future(run_fetch())
                `
            },
            entrypoint: "app.py",
        }, document.getElementById("root"));
    </script>
</body>
</html>